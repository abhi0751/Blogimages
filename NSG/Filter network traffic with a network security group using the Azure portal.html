<!DOCTYPE html>
<html lang="en">
 <head>
  <meta charset="UTF-8">
  <meta name="Generator" content="EditPlus®">
  <meta name="Author" content="">
  <meta name="Keywords" content="">
  <meta name="Description" content="">
  <title>Document</title>
 </head>
 <body>
  <h1 id="tutorial-filter-network-traffic-with-a-network-security-group-using-the-azure-portal">Tutorial: Filter network traffic with a network security group using the Azure portal</h1><p>You can use a network security group to filter network traffic inbound and outbound from a virtual network subnet.</p><p>Network security groups contain security rules that filter network traffic by IP address, port, and protocol. Security rules are applied to resources deployed in a subnet.</p><p>In this tutorial, you learn how to:</p><div class="checklist"><ul><li>Create a network security group and security rules</li><li>Create a virtual network and associate a network security group to a subnet</li><li>Deploy virtual machines (VM) into a subnet</li><li>Test traffic filters</li></ul></div><p>If you don't have an Azure subscription, create a <a href="https://azure.microsoft.com/free/?WT.mc_id=A261C142F" data-linktype="external">free account</a> before you begin.</p><h2 id="prerequisites" class="heading-anchor">Prerequisites</h2><ul><li>An Azure subscription.</li></ul><h2 id="sign-in-to-azure" class="heading-anchor">Sign in to Azure</h2><p>Sign in to the Azure portal at <a href="https://portal.azure.com/" data-linktype="external">https://portal.azure.com</a>.</p><h2 id="create-a-virtual-network" class="heading-anchor">Create a virtual network</h2><ol><li>Select <strong>Create a resource</strong> in the upper left-hand corner of the portal.</li><li>In the search box, enter <strong>Virtual Network</strong>. Select <strong>Virtual Network</strong> in the search results.</li><li>In the <strong>Virtual Network</strong> page, select <strong>Create</strong>.</li><li>In <strong>Create virtual network</strong>, enter or select this information in the <strong>Basics</strong> tab:<br /><div class="table-scroll-wrapper"><table class="table"><caption class="visually-hidden">TABLE 1</caption><thead><tr><th>Setting</th><th>Value</th></tr></thead><tbody><tr><td><strong>Project details</strong></td><td aria-label="No value"> </td></tr><tr><td>Subscription</td><td>Select your subscription.</td></tr><tr><td>Resource group</td><td>Select <strong>Create new</strong>.<br />Enter <strong>myResourceGroup</strong>.<br />Select <strong>OK</strong>.</td></tr><tr><td><strong>Instance details</strong></td><td aria-label="No value"> </td></tr><tr><td>Name</td><td>Enter <strong>myVNet</strong>.</td></tr><tr><td>Region</td><td>Select <strong>(US) East US</strong>.</td></tr></tbody></table></div></li><li>Select the <strong>Review + create</strong> tab, or select the blue <strong>Review + create</strong> button at the bottom of the page.</li><li>Select <strong>Create</strong>.</li></ol><h2 id="create-application-security-groups" class="heading-anchor">Create application security groups</h2><p>An application security group enables you to group together servers with similar functions, such as web servers.</p><ol><li>Select <strong>Create a resource</strong> in the upper left-hand corner of the portal.</li><li>In the search box, enter <strong>Application security group</strong>. Select <strong>Application security group</strong> in the search results.</li><li>In the <strong>Application security group</strong> page, select <strong>Create</strong>.</li><li>In <strong>Create an application security group</strong>, enter or select this information in the <strong>Basics</strong> tab:<br /><div class="table-scroll-wrapper"><table class="table"><caption class="visually-hidden">TABLE 2</caption><thead><tr><th>Setting</th><th>Value</th></tr></thead><tbody><tr><td><strong>Project details</strong></td><td aria-label="No value"> </td></tr><tr><td>Subscription</td><td>Select your subscription.</td></tr><tr><td>Resource group</td><td>Select <strong>myResourceGroup</strong>.</td></tr><tr><td><strong>Instance details</strong></td><td aria-label="No value"> </td></tr><tr><td>Name</td><td>Enter <strong>myAsgWebServers</strong>.</td></tr><tr><td>Region</td><td>Select <strong>(US) East US</strong>.</td></tr></tbody></table></div></li><li>Select the <strong>Review + create</strong> tab, or select the blue <strong>Review + create</strong> button at the bottom of the page.</li><li>Select <strong>Create</strong>.</li><li>Repeat step 4 again, specifying the following values:<br /><div class="table-scroll-wrapper"><table class="table"><caption class="visually-hidden">TABLE 3</caption><thead><tr><th>Setting</th><th>Value</th></tr></thead><tbody><tr><td><strong>Project details</strong></td><td aria-label="No value"> </td></tr><tr><td>Subscription</td><td>Select your subscription.</td></tr><tr><td>Resource group</td><td>Select <strong>myResourceGroup</strong>.</td></tr><tr><td><strong>Instance details</strong></td><td aria-label="No value"> </td></tr><tr><td>Name</td><td>Enter <strong>myAsgMgmtServers</strong>.</td></tr><tr><td>Region</td><td>Select <strong>(US) East US</strong>.</td></tr></tbody></table></div></li><li>Select the <strong>Review + create</strong> tab, or select the blue <strong>Review + create</strong> button at the bottom of the page.</li><li>Select <strong>Create</strong>.</li></ol><h2 id="create-a-network-security-group" class="heading-anchor">Create a network security group</h2><p>A network security group secures network traffic in your virtual network.</p><ol><li>Select <strong>Create a resource</strong> in the upper left-hand corner of the portal.</li><li>In the search box, enter <strong>Network security group</strong>. Select <strong>Network security group</strong> in the search results.</li><li>In the <strong>Network security group</strong> page, select <strong>Create</strong>.</li><li>In <strong>Create network security group</strong>, enter or select this information in the <strong>Basics</strong> tab:<br /><div class="table-scroll-wrapper"><table class="table"><caption class="visually-hidden">TABLE 4</caption><thead><tr><th>Setting</th><th>Value</th></tr></thead><tbody><tr><td><strong>Project details</strong></td><td aria-label="No value"> </td></tr><tr><td>Subscription</td><td>Select your subscription.</td></tr><tr><td>Resource group</td><td>Select <strong>myResourceGroup</strong>.</td></tr><tr><td><strong>Instance details</strong></td><td aria-label="No value"> </td></tr><tr><td>Name</td><td>Enter <strong>myNSG</strong>.</td></tr><tr><td>Location</td><td>Select <strong>(US) East US</strong>.</td></tr></tbody></table></div></li><li>Select the <strong>Review + create</strong> tab, or select the blue <strong>Review + create</strong> button at the bottom of the page.</li><li>Select <strong>Create</strong>.</li></ol><h2 id="associate-network-security-group-to-subnet" class="heading-anchor">Associate network security group to subnet</h2><p>In this section, we'll associate the network security group with the subnet of the virtual network we created earlier.</p><ol><li>In the <strong>Search resources, services, and docs</strong> box at the top of the portal, begin typing <strong>myNsg</strong>. When <strong>myNsg</strong> appears in the search results, select it.</li><li>In the overview page of <strong>myNSG</strong>, select <strong>Subnets</strong> in <strong>Settings</strong>.</li><li>In the <strong>Settings</strong> page, select <strong>Associate</strong>:<span class="mx-imgBorder"><img src="https://raw.githubusercontent.com/abhi0751/Blogimages/main/NSG//associate-nsg-subnet.png" alt="Associate NSG to subnet." width="955" height="575" data-linktype="relative-path" /></span></li><li>Under <strong>Associate subnet</strong>, select <strong>Virtual network</strong> and then select <strong>myVNet</strong>.</li><li>Select <strong>Subnet</strong>, select <strong>default</strong>, and then select <strong>OK</strong>.</li></ol><h2 id="create-security-rules" class="heading-anchor">Create security rules</h2><ol><li>In <strong>Settings</strong> of <strong>myNSG</strong>, select <strong>Inbound security rules</strong>.</li><li>In <strong>Inbound security rules</strong>, select <strong>+ Add</strong>:<span class="mx-imgBorder"><img src="https://raw.githubusercontent.com/abhi0751/Blogimages/main/NSG//add-inbound-rule.png" alt="Add inbound security rule." width="955" height="365" data-linktype="relative-path" /></span></li><li>Create a security rule that allows ports 80 and 443 to the <strong>myAsgWebServers</strong> application security group. In <strong>Add inbound security rule</strong>, enter or select the following information:<br /><div class="table-scroll-wrapper"><table class="table"><caption class="visually-hidden">TABLE 5</caption><thead><tr><th>Setting</th><th>Value</th></tr></thead><tbody><tr><td>Source</td><td>Leave the default of <strong>Any</strong>.</td></tr><tr><td>Source port ranges</td><td>Leave the default of <strong>(*)</strong></td></tr><tr><td>Destination</td><td>Select <strong>Application security group</strong>.</td></tr><tr><td>Destination application security group</td><td>Select <strong>myAsgWebServers</strong>.</td></tr><tr><td>Service</td><td>Leave the default of <strong>Custom</strong>.</td></tr><tr><td>Destination port ranges</td><td>Enter <strong>80,443</strong>.</td></tr><tr><td>Protocol</td><td>Select <strong>TCP</strong>.</td></tr><tr><td>Action</td><td>Leave the default of <strong>Allow</strong>.</td></tr><tr><td>Priority</td><td>Leave the default of <strong>100</strong>.</td></tr><tr><td>Name</td><td>Enter <strong>Allow-Web-All</strong>.</td></tr></tbody></table></div><p><span class="mx-imgBorder"><img src="https://raw.githubusercontent.com/abhi0751/Blogimages/main/NSG//inbound-security-rule.png" alt="Inbound security rule." width="870" height="1602" data-linktype="relative-path" /></span></p></li><li>Complete step 2 again, using the following values:<br /><div class="table-scroll-wrapper"><table class="table"><caption class="visually-hidden">TABLE 6</caption><thead><tr><th>Setting</th><th>Value</th></tr></thead><tbody><tr><td>Source</td><td>Leave the default of <strong>Any</strong>.</td></tr><tr><td>Source port ranges</td><td>Leave the default of <strong>(*)</strong></td></tr><tr><td>Destination</td><td>Select <strong>Application security group</strong>.</td></tr><tr><td>Destination application security group</td><td>Select <strong>myAsgMgmtServers</strong>.</td></tr><tr><td>Service</td><td>Leave the default of <strong>Custom</strong>.</td></tr><tr><td>Destination port ranges</td><td>Enter <strong>3389</strong>.</td></tr><tr><td>Protocol</td><td>Select <strong>TCP</strong>.</td></tr><tr><td>Action</td><td>Leave the default of <strong>Allow</strong>.</td></tr><tr><td>Priority</td><td>Leave the default of <strong>110</strong>.</td></tr><tr><td>Name</td><td>Enter <strong>Allow-RDP-All</strong>.</td></tr></tbody></table></div><div class="alert is-danger"><p class="alert-title"> Caution</p><p>In this article, RDP (port 3389) is exposed to the internet for the VM that is assigned to the <strong>myAsgMgmtServers</strong> application security group.</p><p>For production environments, instead of exposing port 3389 to the internet, it's recommended that you connect to Azure resources that you want to manage using a VPN, private network connection, or Azure Bastion.</p><p>For more information on Azure Bastion, see <a href="https://docs.microsoft.com/en-us/azure/bastion/bastion-overview" data-linktype="relative-path">What is Azure Bastion?</a>.</p></div></li></ol><p>Once you've completed steps 1-3, review the rules you created. Your list should look like the list in the following example:</p><p><span class="mx-imgBorder"><img src="https://raw.githubusercontent.com/abhi0751/Blogimages/main/NSG//security-rules.png" alt="Security rules." width="995" height="450" data-linktype="relative-path" /></span></p><h2 id="create-virtual-machines" class="heading-anchor">Create virtual machines</h2><p>Create two VMs in the virtual network.</p><h3 id="create-the-first-vm" class="heading-anchor">Create the first VM</h3><ol><li>Select <strong>Create a resource</strong> in the upper left-hand corner of the portal.</li><li>Select <strong>Compute</strong>, then select <strong>Virtual machine</strong>.</li><li>In <strong>Create a virtual machine</strong>, enter or select this information in the <strong>Basics</strong> tab:<br /><div class="table-scroll-wrapper"><table class="table"><caption class="visually-hidden">TABLE 7</caption><thead><tr><th>Setting</th><th>Value</th></tr></thead><tbody><tr><td><strong>Project details</strong></td><td aria-label="No value"> </td></tr><tr><td>Subscription</td><td>Select your subscription.</td></tr><tr><td>Resource group</td><td>Select <strong>myResourceGroup</strong>.</td></tr><tr><td><strong>Instance details</strong></td><td aria-label="No value"> </td></tr><tr><td>Virtual machine name</td><td>Enter <strong>myVMWeb</strong>.</td></tr><tr><td>Region</td><td>Select <strong>(US) East US</strong>.</td></tr><tr><td>Availability options</td><td>Leave the default of no redundancy required.</td></tr><tr><td>Image</td><td>Select <strong>Windows Server 2019 Datacenter - Gen1</strong>.</td></tr><tr><td>Azure Spot instance</td><td>Leave the default of unchecked.</td></tr><tr><td>Size</td><td>Select <strong>Standard_D2s_V3</strong>.</td></tr><tr><td><strong>Administrator account</strong></td><td aria-label="No value"> </td></tr><tr><td>Username</td><td>Enter a username.</td></tr><tr><td>Password</td><td>Enter a password.</td></tr><tr><td>Confirm password</td><td>Reenter password.</td></tr><tr><td><strong>Inbound port rules</strong></td><td aria-label="No value"> </td></tr><tr><td>Public inbound ports</td><td>Select <strong>None</strong>.</td></tr></tbody></table></div></li><li>Select the <strong>Networking</strong> tab.</li><li>In the <strong>Networking</strong> tab, enter or select the following information:<br /><div class="table-scroll-wrapper"><table class="table"><caption class="visually-hidden">TABLE 8</caption><thead><tr><th>Setting</th><th>Value</th></tr></thead><tbody><tr><td><strong>Network interface</strong></td><td aria-label="No value"> </td></tr><tr><td>Virtual network</td><td>Select <strong>myVNet</strong>.</td></tr><tr><td>Subnet</td><td>Select <strong>default (10.0.0.0/24)</strong>.</td></tr><tr><td>Public IP</td><td>Leave the default of a new public IP.</td></tr><tr><td>NIC network security group</td><td>Select <strong>None</strong>.</td></tr></tbody></table></div></li><li>Select the <strong>Review + create</strong> tab, or select the blue <strong>Review + create</strong> button at the bottom of the page.</li><li>Select <strong>Create</strong>.</li></ol><h3 id="create-the-second-vm" class="heading-anchor">Create the second VM</h3><p>Complete steps 1-7 again, but in step 3, name the VM <strong>myVMMgmt</strong>. The VM takes a few minutes to deploy.</p><p>Don't continue to the next step until the VM is deployed.</p><h2 id="associate-network-interfaces-to-an-asg" class="heading-anchor">Associate network interfaces to an ASG</h2><p>When the portal created the VMs, it created a network interface for each VM, and attached the network interface to the VM.</p><p>Add the network interface for each VM to one of the application security groups you created previously:</p><ol><li>In the <strong>Search resources, services, and docs</strong> box at the top of the portal, begin typing <strong>myVMWeb</strong>. When the <strong>myVMWeb</strong> virtual machine appears in the search results, select it.</li><li>In <strong>Settings</strong>, select <strong>Networking</strong>.</li><li>Select the <strong>Application security groups</strong> tab, then select <strong>Configure the application security groups</strong>.<span class="mx-imgBorder"><img src="https://raw.githubusercontent.com/abhi0751/Blogimages/main/NSG//configure-app-sec-groups.png" alt="Configure application security groups." width="955" height="374" data-linktype="relative-path" /></span></li><li>In <strong>Configure the application security groups</strong>, select <strong>myAsgWebServers</strong>. Select <strong>Save</strong>.<span class="mx-imgBorder"><img src="https://raw.githubusercontent.com/abhi0751/Blogimages/main/NSG//select-asgs.png" alt="Select application security groups." width="955" height="880" data-linktype="relative-path" /></span></li><li>Complete steps 1 and 2 again, searching for the <strong>myVMMgmt</strong> virtual machine and selecting the <strong>myAsgMgmtServers</strong> ASG.</li></ol><h2 id="test-traffic-filters" class="heading-anchor">Test traffic filters</h2><ol><li>Connect to the <strong>myVMMgmt</strong> VM. Enter <strong>myVMMgmt</strong> in the search box at the top of the portal. When <strong>myVMMgmt</strong> appears in the search results, select it. Select the <strong>Connect</strong> button.</li><li>Select <strong>Download RDP file</strong>.</li><li>Open the downloaded rdp file and select <strong>Connect</strong>. Enter the user name and password you specified when creating the VM.</li><li>Select <strong>OK</strong>.</li><li>You may receive a certificate warning during the connection process. If you receive the warning, select <strong>Yes</strong> or <strong>Continue</strong>, to continue with the connection.The connection succeeds, because port 3389 is allowed inbound from the internet to the <strong>myAsgMgmtServers</strong> application security group.<p>The network interface for <strong>myVMMgmt</strong> is associated with the <strong>myAsgMgmtServers</strong> application security group and allows the connection.</p></li><li>Open a PowerShell session on <strong>myVMMgmt</strong>. Connect to <strong>myVMWeb</strong> using the following example:<br /><div id="code-try-0" class="codeHeader" data-bi-name="code-header"><p><span class="language">PowerShell</span><button class="action position-relative" type="button" data-bi-name="copy" aria-label="Copy code"></button><button class="action position-relative" type="button" data-bi-name="copy" aria-label="Copy code">Copy</button></p><div class="successful-copy-alert position-absolute right-0 top-0 left-0 bottom-0 display-flex align-items-center justify-content-center has-text-success-invert has-background-success is-transparent" aria-hidden="true"> </div></div><pre class="has-inner-focus" tabindex="0"><code class="lang-powershell" data-author-content="mstsc /v:myVmWeb ">mstsc /v:myVmWeb
</code></pre><p>The RDP connection from <strong>myVMMgmt</strong> to <strong>myVMWeb</strong> succeeds because virtual machines in the same network can communicate with each over any port by default.</p><p>You can't create an RDP connection to the <strong>myVMWeb</strong> virtual machine from the internet. The security rule for the <strong>myAsgWebServers</strong> prevents connections to port 3389 inbound from the internet. Inbound traffic from the Internet is denied to all resources by default.</p></li><li>To install Microsoft IIS on the <strong>myVMWeb</strong> virtual machine, enter the following command from a PowerShell session on the <strong>myVMWeb</strong> virtual machine:<br /><div id="code-try-1" class="codeHeader" data-bi-name="code-header"><div class="successful-copy-alert position-absolute right-0 top-0 left-0 bottom-0 display-flex align-items-center justify-content-center has-text-success-invert has-background-success is-transparent" aria-hidden="true"> </div></div><pre class="has-inner-focus" tabindex="0"><code class="lang-powershell" data-author-content="Install-WindowsFeature -name Web-Server -IncludeManagementTools "><span class="hljs-pscommand">Install-WindowsFeature</span><span class="hljs-parameter"> -name</span> <span class="hljs-pscommand">Web-Server</span><span class="hljs-parameter"> -IncludeManagementTools</span>
</code></pre></li><li>After the IIS installation is complete, disconnect from the <strong>myVMWeb</strong> virtual machine, which leaves you in the <strong>myVMMgmt</strong> virtual machine remote desktop connection.</li><li>Disconnect from the <strong>myVMMgmt</strong> VM.</li><li>In the <strong>Search resources, services, and docs</strong> box at the top of the Azure portal, begin typing <strong>myVMWeb</strong> from your computer. When <strong>myVMWeb</strong> appears in the search results, select it. Note the <strong>Public IP address</strong> for your VM. The address shown in the following example is 23.96.39.113, but your address is different:<span class="mx-imgBorder"><img src="https://raw.githubusercontent.com/abhi0751/Blogimages/main/NSG/c/public-ip-address.png" alt="Public IP address." data-linktype="relative-path" /></span></li><li>To confirm that you can access the <strong>myVMWeb</strong> web server from the internet, open an internet browser on your computer and browse to <code>http://&lt;public-ip-address-from-previous-step&gt;</code>.</li></ol><p>You see the IIS welcome screen, because port 80 is allowed inbound from the internet to the <strong>myAsgWebServers</strong> application security group.</p><p>The network interface attached for <strong>myVMWeb</strong> is associated with the <strong>myAsgWebServers</strong> application security group and allows the connection.</p><h2 id="clean-up-resources" class="heading-anchor">Clean up resources</h2><p>When no longer needed, delete the resource group and all of the resources it contains:</p><ol><li>Enter <strong>myResourceGroup</strong> in the <strong>Search</strong> box at the top of the portal. When you see <strong>myResourceGroup</strong> in the search results, select it.</li><li>Select <strong>Delete resource group</strong>.</li><li>Enter <strong>myResourceGroup</strong> for <strong>TYPE THE RESOURCE GROUP NAME:</strong> and select <strong>Delete</strong>.</li></ol>
 </body>
</html>
